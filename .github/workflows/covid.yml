name: covid

on: push

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
        - uses: actions/checkout@v1
        - name: Download data
          run: wget -O _projects/covid/owid-covid-data.csv https://covid.ourworldindata.org/data/owid-covid-data.csv
        - name: Install setup tools
          run: sudo apt-get install python3-setuptools
        - name: Install wheel
          run: pip3 install wheel
        - name: Install dependencies
          run: pip3 install -r _projects/covid/requirements.txt
        - name: Run command
          run: |
            cd _projects/covid/
            python3 plots.py
            cd ../..
        - name: Commit files
          run: |
            git config --local user.email "shreshthtuli@gmail.com"
            git config --local user.name "Shreshth Tuli"
            git add -A
            git commit -m "Auto commit (COVID-19 update using GitHub workflow)" -a
        - name: Push changes
          uses: ad-m/github-push-action@master
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            branch: ${{ github.ref }}
        - name: Install jekyll
          run: |
            sudo apt-get install ruby-full build-essential zlib1g-dev
            echo '# Install Ruby Gems to ~/gems' >> ~/.bashrc
            echo 'export GEM_HOME="$HOME/gems"' >> ~/.bashrc
            echo 'export PATH="$HOME/gems/bin:$PATH"' >> ~/.bashrc
            source ~/.bashrc
            sudo gem install jekyll bundler
            bundle install
        - name: Rebuild page
          run: |
            sudo chmod +x bin/deployCI
            sudo ./bin/deployCI
        - name: Commit files
          run: |
            sudo git config --local user.email "shreshthtuli@gmail.com"
            sudo git config --local user.name "Shreshth Tuli"
            sudo git add -fA
            sudo git commit --allow-empty -m "$(git log -1 --pretty=%B) [ci skip]"
        - name: Push changes
          uses: ad-m/github-push-action@master
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            force: true
            branch: gh-pages

